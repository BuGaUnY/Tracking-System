{% extends 'base.html' %}

{% block title %}<title>Check in | {{activity}} </title>{% endblock %}

{% block content %}
<div class="card mb-2">
    <div class="card-body">
        <h5 class="card-title">{{activity.title}}</h5>
        <div class="d-grid gap-2">
            <a href="{{activity.get_absolute_organizer_owner_activity_ticket_list_url}}" class="btn btn-success">
                <i class="fa-solid fa-people-roof"></i> รายชื่อผู้เข้าร่วม</a>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">{{activity.title}}</h5>
        <p class="card-text">Check in QR Code สำหรับผู้เข้าร่วมกิจกรรม</p>
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-warning" onclick="startScanner()">
                <i class="fa-solid fa-qrcode"></i> Scan QR Code</button>
        </div>
    </div>
</div>

<div id="check-in-partials"></div>

<form id="check-in" hx-get="{% url 'ticket-checkin' %}" hx-target="#check-in-partials" onsubmit="return handleSubmit(event)">
    <input type="text" name="activity_uid" value="{{activity.uid}}" style="visibility:hidden">
    <input type="text" id="scanCode" name="ticket_uid" style="visibility:hidden">
    <button type="submit" id="clickButton" style="visibility:hidden">submit</button>
</form>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ZXing (QR Code Reader) -->
<script src="https://unpkg.com/@zxing/library@latest"></script>

<!-- Video element for QR code scanner -->
<video id="qr-reader" style="width:100%;"></video>

<script>
    function startScanner() {
        const codeReader = new ZXing.BrowserQRCodeReader();
        console.log('เริ่มต้นการอ่าน QR Code...');

        const videoElement = document.getElementById('qr-reader');
        
        if (!videoElement) {
            console.error("ไม่พบวิดีโอสำหรับ QR Code");
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: 'ไม่พบวิดีโอสำหรับ QR Code',
                showConfirmButton: true
            });
            return;
        }

        const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;

        codeReader.decodeOnceFromVideoDevice(null, 'qr-reader')
            .then((result) => {
                console.log('QR Code ที่สแกน:', result.text);

                if (uuidPattern.test(result.text)) {
                    document.getElementById("scanCode").value = result.text;
                    document.getElementById("clickButton").click();
                } else {
                    Swal.fire({
                        position: 'center',
                        icon: 'error',
                        title: 'ข้อมูลที่สแกนไม่ถูกต้อง',
                        text: 'ข้อมูล QR ไม่ตรงกับรูปแบบ UUID ที่คาดหวัง',
                        showConfirmButton: true
                    });
                }
            })
            .catch((err) => {
                console.error("ไม่สามารถอ่าน QR Code ได้:", err);
                Swal.fire({
                    position: 'center',
                    icon: 'error',
                    title: 'ไม่สามารถอ่าน QR Code ได้',
                    text: 'เกิดข้อผิดพลาด: ' + err.message,
                    showConfirmButton: true
                });
            });
    }

    function handleSubmit(event) {
        event.preventDefault(); // ป้องกันการส่งฟอร์มแบบปกติ

        // ดึงข้อมูลจากฟอร์ม
        const formData = new FormData(event.target);
        const url = event.target.getAttribute('hx-get');

        fetch(url + '?' + new URLSearchParams(formData), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // บอกว่าการร้องขอเป็น AJAX
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error();
            }
            return response.text();
        })
        .then(data => {
            document.getElementById('check-in-partials').innerHTML = data; // แสดงผลลัพธ์
        })
        .catch(error => {
            console.error('เกิดข้อผิดพลาดในการส่งฟอร์ม:', error);
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: 'ข้อมูลไม่ถูกต้อง',
                showConfirmButton: true
            });
        });
    }
</script>
{% endblock %}
